#!/usr/bin/make -f

vafilt = $(subst $(2)=,,$(filter $(2)=%,$(1)))
CHANGELOG_VARS := $(shell dpkg-parsechangelog | sed -n 's/ /_/g;/^[^_]/s/^\([^:]*\):_\(.*\)/\1=\2/p')
PKGSOURCE  := $(call vafilt,$(CHANGELOG_VARS),Source)
PKGVERSION := $(call vafilt,$(CHANGELOG_VARS),Version)
UPSTREAM_VCS = git@github.com:tmarble/kspsig.git
UPSTREAM_VERSION = v$(PKGVERSION)
SOURCE_DIR = $(PKGSOURCE)-$(PKGVERSION)
NATIVE_TARBALL = $(PKGSOURCE)_$(PKGVERSION).native.tar.bz2

%: 
	dh $@

override_dh_auto_build:
	dh_auto_build
	help2man --output kspsig.1 --include=kspsig.h2m ./kspsig

get-orig-source:
	mkdir ../tarballs
	git clone --no-checkout $(UPSTREAM_VCS) ../tarballs/$(SOURCE_DIR)
	( cd ../tarballs/$(SOURCE_DIR); git checkout $(UPSTREAM_VERSION) )
	rm -f ../$(NATIVE_TARBALL)
	tar -C ../tarballs -jcf ../$(NATIVE_TARBALL) --exclude='.git*' ./$(SOURCE_DIR)
	rm -rf ../tarballs
